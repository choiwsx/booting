<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>

        *{
            font-family: NanumBarunGothic;
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
        }
        body{
            background: #dee1e3;
        }
        .recipe-container{
            max-width: 1100px;
            margin: 0 auto;
        }

        .recipe-main{
            top: 50px;
            width: 1100px;
            height: 598px;
            position: relative;
            text-align: center;
            border-radius: 15px;
            box-shadow: 0 2px 2px rgba(0,0,0,0.15);
        }
        .recipe-main img {
            border: 1px solid gray;
            width: 1100px;
            height: 598px;
            border-radius: 15px;
            -webkit-filter: contrast(65%);
        }

        .recipe-main-title,.recipe-main-tag,.recipe-main-user,.recipe-main-regDate{
            width: 100%;
            position: absolute;
            color: white;
            text-align: left;
            z-index: 2;
        }

        .recipe-main-title {
            top: 330px;
            left: 200px;
            font-size: 50px;
            color: white;
        }
        .recipe-tags{
            display: inline-block;
            float: left;
        }

        .recipe-main-tag {
            top: 420px;
            left: 200px;
            font-size: 25px;
            color: white;
        }
        .recipe-main-user{
            top: 520px;
            left: 400px;
            font-size: 20px;
        }
        .recipe-main-regDate{
            top: 535px;
            left: 550px;
            font-size: 13px;
        }

        /* 레시피 소개 */

        .recipe-content{

            margin-top: 100px;
            left: 25%;
            right: 25%;
            text-align: center;
            font-size: 40px;
            color: silver;

        }

        .recipe-content p:before {
            content: "\201C";
            font-size: 80px;
        }
        .recipe-content p:after {
            content: "\201D";
            font-size: 80px;
        }

        /* 레시피 난이도,양,조리시간 */
        .starR{
            background: url('http://miuu227.godohosting.com/images/icon/ico_review.png') no-repeat right 0;
            background-size: auto 100%;
            width: 30px;
            height: 30px;
            display: inline-block;
            text-indent: -9999px;
            cursor: pointer;
        }
        .starR.on{background-position:0 0;}

        .recipe-info{
            border: 1px solid white;
            border-radius: 10px;
            margin-top: 5%;
            margin-left: 20%;
            margin-right: 20%;
            text-align: center;
            background-color: whitesmoke;
            box-shadow: 0 2px 2px rgba(0,0,0,0.15);
        }
        .recipe-info p{
            font-size: 20px;
            text-align: left;
            margin-left: 50px;
            color: rgba(65, 56, 56, 0.698);

        }
        /* 레시피 재료 */

        .recipe-ingredients{
            margin-top: 50px;
            border: 1px solid white;
            border-radius: 10px;
            margin-left: 25%;
            margin-right: 25%;
            text-align: center;
            background-color: white;
            box-shadow: 0 2px 2px rgba(0,0,0,0.15);
        }
        .recipe-ingredients p{
            font-size: 17px;
            text-align: left;
            margin-left: 50px;
            color: rgba(65, 56, 56, 0.698);
        }
        table {
            width: 100%;
            border-top: 1px solid rgba(65, 56, 56, 0.698);
            border-collapse: collapse;
        }
        th {
            margin-bottom: 5px;
            color: rgba(65, 56, 56, 0.698);
            padding: 10px;
            border-top: 1px solid rgba(0,0,0,0.15);
        }

        /* 레시피 순서 */

        .recipe-steps{
            border: 1px solid white;
            border-radius: 10px;
            color: rgba(65, 56, 56, 0.698);
            background-color: white;
            margin-top: 50px;
            margin-left: 13%;
            margin-right: 13%;
            margin-bottom: 5%;
            box-shadow: 0 2px 2px rgba(0,0,0,0.15);
        }
        .recipe-steps p{
            font-size: 30px;
            margin-left: 10%;
        }

        .recipe-step{
            height: 300px;
            border: 1px solid rgba(65, 56, 56, 0.698);
            border-radius: 10px;
            margin-left: 10%;
            margin-right: 10%;
            margin-top: 5%;
            margin-bottom: 5%;
        }

        .recipe-step img{
            width: 300px;
            height: 300px;
            border-radius: 10px;
            margin-right: 20px;
            float: left;
        }
        .recipe-step p{
            font-size: 16px;
        }

        /*레시피 좋아요,찜*/
        .recipe-scrapAndLike{
            height: 100px;
            margin-left: 10%;
            margin-right: 10%;
            margin-top: 5%;
            margin-bottom: 5%;
            border: 1px solid white;
            border-radius: 50px;
            background-color: white;
            box-shadow: 0 2px 2px rgba(0,0,0,0.15);
        }
        #scrapDiv,#likeDiv{
            margin-left: 20%;
            margin-right: 20%;
            margin-top: 15px;
            display: inline-block;
            text-align: center;
        }
        #scrapDiv input,#likeDiv input{
            height: 75px;
            width: 75px;
            box-shadow: 0 2px 2px rgba(0,0,0,0.15);

        }

        /* 레시피 저자 */

        .recipe-writer{
            height: 150px;
            margin-left: 10%;
            margin-right: 10%;
            margin-top: 5%;
            margin-bottom: 5%;
            border: 1px solid white;
            border-radius: 50px;
            background-color: white;
            box-shadow: 0 2px 2px rgba(0,0,0,0.15);
        }
        .recipe-writer img{
            width: 150px;
            height: 145px;
            margin-right: 30px;
            border-radius: 50px;
            float: left;
        }

        .recipe-writer p{
            margin: 10px;
            font-size: 35px;
        }
        .recipe-writer h5{
            margin: 10px;
            font-size: 20px;
        }

        .input-container {
            max-width: 1100px;
            margin: 0 auto;
            text-align: center;
        }
        .input-container input{
            height: 50px;
            width: 30vw;
        }
        .input-container button{
            height: 50px;
            width: 50px;
            box-shadow: 0 2px 2px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>

<div class="recipe-container">
    <input type="hidden" id="recipeNo" th:value="${recipe.recipeNo}">
    <input type="hidden" id="userId" th:value= "${#authentication.principal.userId}">

    <div class="recipe-main">
        <img th:src="@{'/display?fileName='+${recipe.thumbnail}}" alt="">
        <div class="recipe-main-title"><p th:text="${recipe.title}"></p></div>
        <div th:each="tag, stat: *{recipe.tags}" class="recipe-tags"> <div class="recipe-main-tag"><h4 th:text="${'#'+tag.content}"></h4></div></div>
        <div class="recipe-main-user"><p th:text="${recipe.profile.userId}"></p></div>
        <div class="recipe-main-regDate"><p th:text="${recipe.regDate}"></p></div>
    </div>
    <div class="recipe-content"><p th:text="${recipe.content}"></p></div>
    <div class="recipe-info"><p>info</p>
        <table>
            <tbody>
            <tr>
                <th>난이도</th><th>조리시간</th><th>양</th>
            </tr>
            <tr>
                <th><th:block th:each="num : ${#numbers.sequence(1, 5)}">
                    <th:block th:if="${num}<=${recipe.difficulty}">
                        <span class="starR on">별1</span>
                    </th:block>
                </th:block>
                    </th>
                <th><h4 th:text="${recipe.cookingTime}"></h4></th><th><h4 th:text="${recipe.serving}"></h4></th>
            </tr>
            </tbody>
        </table>
    </div>
    <div class="recipe-ingredients"><p>재료</p>
        <table>
            <tbody>
            <tr th:each="ingredient, stat: *{recipe.ingredients}">
                <!--                <th th:text="${stat.count}" ></th>-->
                <th th:text="${ingredient.name}"></th>
                <th th:text="${ingredient.amount}"></th>
            </tr>
            </tbody>
        </table>
    </div>
    <div class="recipe-steps">
        <p>요리 순서</p>
        <hr>
        <div th:each="step, stat: *{recipe.steps}" class="recipe-step">
            <img th:src="@{'/display?fileName='+${step.getThumbnail()}}" alt="">
            <h2 th:text="${'('+stat.count+')'}"></h2><br>
            <p th:text="${step.getContent()}"></p>
        </div>

        <br>
    </div>
    <div class="recipe-scrapAndLike">
    <div id="scrapDiv">
        <!-- 여기서 getMapping으로 보낸 데이터 확인해서 이미 내가찜했으면 찜취소로 보여줘야함 -->
        <input th:if="${scrap == null}"
               type="button" th:id="create-scrap" value="찜 하기">
        <input th:unless="${scrap == null}"
               type="button" th:id="delete-scrap" value="찜 취소">
    </div>
    <div id="likeDiv">
        <input th:if="${like == null}"
               type="button" th:id="create-like" value="♡">
        <input th:unless="${like == null}"
               type="button" th:id="delete-like" value="♥">
    </div>
    </div>

    <div class="recipe-writer">
        <img th:src="@{'/display?fileName='+${profile.thumbnail}}" alt="">
        <p th:text="${profile.nickname}"></p>
        <h5 th:text="${profile.bio}"></h5>
        <h6>구독자 수</h6>
<!--        <input type="button" class="subscribeBtn" value="구독하기">-->
    </div>
</div>
<div class="comments-container">
    <ul id="comments-list" class="comments-list">
        
    </ul>
</div>

<th:block th:insert="recipe/comment">
</th:block>

<div class="input-container">
    <input type="text" id="reply" placeholder="Comment">
    <button id="btnReply">작성</button>
</div>

<hr>
<br>

<!--  여기서 이거를 누르면 likelist recipeNo를 같이 보내줘야함-->
<div id="countDiv" th:if="${like != null}">
    <a th:href="@{'/recipe/likelist?recipeNo='+${recipe.recipeNo}}"><p th:if="${counts.size() == 1}" th:type="button"
                                                                       th:text="${counts[0].nickname}+'님이 좋아합니다'"></p></a>
    <a th:href="@{'/recipe/likelist?recipeNo='+${recipe.recipeNo}}"><p th:unless="${counts.size() == 1}" th:type="button"
                                                                       th:text="${counts[0].nickname}+'님 외 '+${counts.size()-1}+'명이 좋아합니다'"></p></a>
</div>
<!--<a href="/recipe/likelist">게시물 좋아요한 유저 리스트</a>-->
<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script type="text/javascript">

    $(document).ready(function() {
        // let scrapDiv = $("#scrapDiv");

        $(document).on("click", "#create-scrap", (function (event) {
            btn_scrapsubmit(true);
        }));

        $(document).on("click", "#delete-scrap", (function (event) {
            btn_scrapsubmit(false);
        }));

        $(document).on("click", "#create-like", (function (event) {
            btn_likesubmit(true);
        }));

        $(document).on("click", "#delete-like", (function (event) {
            btn_likesubmit(false);
        }));
    })

    function btn_likesubmit(flag) {
        var likeId = {};
        likeId["user"] = $("#userId").val();
        likeId["recipe"] = $("#recipeNo").val();

        if(flag)
        {
            // 빈칸하트를 누르면
            console.log("좋아요 저장 : ",flag);
            $.ajax({
                type: "POST",
                contentType: "application/json",
                url: "/recipe/saveLikeAjax",
                data: JSON.stringify(likeId),
                dataType: 'json',
                success:
                // function (data) {
                // console.log("SUCESS: ", data);
                    get_like().then(function(response) {
                        console.log("RESPONSE 좋아요 : ", response);
                        likeDiv.innerHTML = "";
                        likeDiv.innerHTML = "<input type='button' id='delete-like' value='♥'>";
                    })
                // }
            });
        }
        else
        {
            // 찜 취소를 누르면
            console.log("좋아요 삭제 : ",flag);
            $.ajax({
                type: "POST",
                contentType: "application/json",
                url: "/recipe/deleteLikeAjax",
                data: JSON.stringify(likeId),
                dataType: 'json',
                success:
                    get_like().then(function(response) {
                        console.log("RESPONSE좋아요 취소 : ", response);
                        likeDiv.innerHTML = "";
                        likeDiv.innerHTML = "<input type='button' id='create-like' value='♡'>";
                    })
            });
        }
    }

    function get_like() {
        return $.ajax({
            type: "GET",
            url: "/recipe/goLike/" + $("#userId").val() + "/" + $("#recipeNo").val(),
            contentType: 'application/json'
        });
    }

    function get_scrap() {
        return $.ajax({
            type: "GET",
            url: "/recipe/goScrap/" + $("#userId").val() + "/" + $("#recipeNo").val(),
            contentType: 'application/json'
        });
    }

    function btn_scrapsubmit(flag) {
        var scrapId = {};
        scrapId["user"] = $("#userId").val();
        scrapId["recipe"] = $("#recipeNo").val();

        if (flag) {
            // 찜하기를 누르면
            console.log("저장 : ", flag);
            $.ajax({
                type: "POST",
                contentType: "application/json",
                url: "/recipe/saveScrapAjax",
                data: JSON.stringify(scrapId),
                dataType: 'json',
                success:
                    get_scrap().then(function (response) {
                        console.log("RESPONSE찜하기 : ", response);
                        scrapDiv.innerHTML = "";
                        scrapDiv.innerHTML = "<input type='button' id='delete-scrap' value='찜 취소'>";
                    })
            });
        } else {
            // 찜 취소를 누르면
            console.log("삭제 : ", flag);
            $.ajax({
                type: "POST",
                contentType: "application/json",
                url: "/recipe/deleteScrapAjax",
                data: JSON.stringify(scrapId),
                dataType: 'json',
                success:
                // function (data) {
                // console.log("SUCESS: ", data);
                    get_scrap().then(function (response) {
                        console.log("RESPONSE찜취소 : ", response);
                        scrapDiv.innerHTML = "";
                        scrapDiv.innerHTML = "<input type='button' id='create-scrap' value='찜 하기'>";
                    })
                // }
            });
        }
    }

</script>
</body>
</html>