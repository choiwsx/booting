<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Title</title>
</head>
<body>
여기는 레시피 리스트 이란다.
<table>
    <tr>
        <td th:text="${recipe.title}"></td><br>
        <td th:text="${recipe.thumbnail}"></td><br>
        <td th:text="${recipe.content}"></td>
    </tr>
</table>
<input type="hidden" id="userId" th:value="user01">
<!--    <input type="hidden" id="userId" th:value="${session.userId}">-->
<input type="hidden" id="recipeNo" th:value="${recipe.recipeNo}">
<div id="scrapDiv">
    <!-- 여기서 getMapping으로 보낸 데이터 확인해서 이미 내가찜했으면 찜취소로 보여줘야함 -->
    <input th:if="${scrap == null}"
           type="button" th:id="create-scrap" value="찜 하기">
    <input th:unless="${scrap == null}"
           type="button" th:id="delete-scrap" value="찜 취소">
</div>
<div id="likeDiv">
    <input th:if="${like == null}"
       type="button" th:id="create-like" value="♡">
    <input th:unless="${like == null}"
           type="button" th:id="delete-like" value="♥">
</div>
<!--  여기서 이거를 누르면 likelist recipeNo를 같이 보내줘야함  -->
<div id="countDiv" th:if="${like != null}">
<a th:href="@{'/recipe/likelist?recipeNo='+${recipe.recipeNo}}"><p th:if="${counts.size() == 1}" th:type="button"
                                                          th:text="${counts[0].nickname}+'님이 좋아합니다'"></p></a>
<a th:href="@{'/recipe/likelist?recipeNo='+${recipe.recipeNo}}"><p th:unless="${counts.size() == 1}" th:type="button"
                              th:text="${counts[0].nickname}+'님 외 '+${counts.size()-1}+'명이 좋아합니다'"></p></a>
</div>
<!--<a href="/recipe/likelist">게시물 좋아요한 유저 리스트</a>-->
<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script type="text/javascript">

    $(document).ready(function(){
        // let scrapDiv = $("#scrapDiv");

        $(document).on("click","#create-scrap",(function(event) {
            btn_scrapsubmit(true);
        }));

        $(document).on("click","#delete-scrap",(function(event) {
            btn_scrapsubmit(false);
        }));

        $(document).on("click", "#create-like",(function(event){
            btn_likesubmit(true);
        }));

        $(document).on("click", "#delete-like",(function(event){
            btn_likesubmit(false);
        }));

    });

    function btn_likesubmit(flag) {
        var like = {};
        like["userId"] = $("#userId").val();
        like["recipeNo"] = $("#recipeNo").val();

        if(flag)
        {
            // 빈칸하트를 누르면
            console.log("좋아요 저장 : ",flag);
            $.ajax({
                type: "POST",
                contentType: "application/json",
                url: "/recipe/saveLikeAjax",
                data: JSON.stringify(like),
                dataType: 'json',
                success:
                // function (data) {
                // console.log("SUCESS: ", data);
                    get_like().then(function(response) {
                        console.log("RESPONSE 좋아요 : ", response);
                        likeDiv.innerHTML = "";
                        likeDiv.innerHTML = "<input type='button' id='delete-like' value='♥'>";
                    })
                // }
            });
        }
        else
        {
            // 찜 취소를 누르면
            console.log("좋아요 삭제 : ",flag);
            $.ajax({
                type: "POST",
                contentType: "application/json",
                url: "/recipe/deleteLikeAjax",
                data: JSON.stringify(like),
                dataType: 'json',
                success:
                // function (data) {
                // console.log("SUCESS: ", data);
                    get_like().then(function(response) {
                        console.log("RESPONSE좋아요 취소 : ", response);
                        likeDiv.innerHTML = "";
                        likeDiv.innerHTML = "<input type='button' id='create-like' value='♡'>";
                    })
                // }
            });
        }
    }

    function get_like() {
        return $.ajax({
            type : "GET",
            url: "/recipe/goLike/"+$("#userId").val()+"/"+$("#recipeNo").val(),
            contentType : 'application/json'
        });
    }

    function get_scrap() {
        return $.ajax({
            type : "GET",
            url: "/recipe/goScrap/"+$("#userId").val()+"/"+$("#recipeNo").val(),
            contentType : 'application/json'
        });
    }

    function btn_scrapsubmit(flag) {
        var scrap = {};
        scrap["userId"] = $("#userId").val();
        scrap["recipeNo"] = $("#recipeNo").val();

        if(flag)
        {
            // 찜하기를 누르면
            console.log("저장 : ",flag);
            $.ajax({
                type: "POST",
                contentType: "application/json",
                url: "/recipe/saveScrapAjax",
                data: JSON.stringify(scrap),
                dataType: 'json',
                success:
                // function (data) {
                // console.log("SUCESS: ", data);
                    get_scrap().then(function(response) {
                        console.log("RESPONSE찜하기 : ", response);
                        scrapDiv.innerHTML = "";
                        scrapDiv.innerHTML = "<input type='button' id='delete-scrap' value='찜 취소'>";
                    })
                // }
            });
        }
        else
        {
            // 찜 취소를 누르면
            console.log("삭제 : ",flag);
            $.ajax({
                type: "POST",
                contentType: "application/json",
                url: "/recipe/deleteScrapAjax",
                data: JSON.stringify(scrap),
                dataType: 'json',
                success:
                // function (data) {
                // console.log("SUCESS: ", data);
                    get_scrap().then(function(response) {
                        console.log("RESPONSE찜취소 : ", response);
                        scrapDiv.innerHTML = "";
                        scrapDiv.innerHTML = "<input type='button' id='create-scrap' value='찜 하기'>";
                    })
                // }
            });
        }

    }

</script>
</body>
</html>